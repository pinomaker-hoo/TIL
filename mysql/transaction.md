# Transaction

## 1. Transaction

트랜잭션이라 데이터베이스에서 처리하는 단위를 말하며, 원자성, 일관성, 격리성, 영속성 4가지 특징을 가지고 있다.

- 원자성(Atomicity)

  트랜잭션은 분해가 불가능한 가장 작은 단위이기에 1개의 트랜잭션은 전부 처리되거나 하나도 처리되면 안 된다.

- 일관성(Consistency)

  일관된 상태의 데이터베이스에서 하나의 트랜잭션이 성공하면 데이터베이스는 일관된 상태여야한다.

- 격리성(Isolation)

  실행 중인 트랜잭션의 중간 결과를 다른 트랜잭션에서 접근이 불가능해야한다.

- 영속성(Durability)

  트랜잭션이 성공적으로 완료되면 결과가 데이터베이스에 영속적으로 저장되어야한다.

## 2. DB Lock

Lock은 동시에 여러 프로세스나 스레드가 공유하는 리소스에 대한 접근을 조절한다. 여러 프로세스나 스레드가 동시에 같은 리소스를 수정하게되면 동시성 문제나 일관성을 유지할 수 없기에 적절하게 사용해야한다.

이를 DB 관점에서 바라보면 A, B 트랜잭션에서 같은 Row에 대해서 접근하여 조회하거나 수정할려고 할 때는 문제가 발생할 수 있다. 이를 위하여 동시에 같은 Row에 접근을 못 하게 적절하게 Lock을 걸어주는 것이 중요하다.

### DB Lock 설정 범위

DB Lock은 적용할 수 있는 설정 범위가 다양하다.

- 데이터베이스 : 전체 데이터 베이스를 기준으로 Lock을 설정하며 1개의 트랜잭션만이 접근 가능하지만 잘 사용하지 않는다.

- 파일 : 데이터베이스 파일을 기준으로 Lock을 설정하는 데 여기서 파일이란 테이블, Row 등 실제 데이터가 쓰여지는 물리적인 저장소이다.

- 테이블 : 테이블의 모든 행을 업데이터 하는 등의 전체 테이블에 영향을 주는 변경을 수행할 때 유용하며, DDL 구문과 함께 사용되어 DDL Lock이라고도 불린다.

- 페이지, 블럭 : 파일의 일부인 페이지나 블록을 기준으로도 가능하지만 잘 사용하지 않는다.

- 컬럼 : 지원하는 DBMS도 적고, 설정 및 해제의 리소스가 많이 들어 잘 사용하지 않는다.

- 행 : 1개의 행을 기준으로 Lock을 설정하는 데 가장 기본적으로 사용하게 된다.

### DB Lock의 종류

1. 공유락(Shared Lock)

   데이터를 조회할 경우 사용 되어 Read Lock이라고도 하며, S로 자주 표기한다. 여러 사용자가 동시에 데이터를 읽어도 문제가 없어도 데이터 일관성에 영향을 주지 않아 동시에 접근이 가능하다. 이는 동시에 접근하여 조회는 가능하지만 수정은 불가능하다는 것이며, 공유 락이 설정된 상태에서는 베타 락을 사용할 수 없다.

2. 베타 락(Exclusive Lock)

   베타 락은 데이터를 변경할 때 사용하는 Lock으로 Write Lock이라고 하며, X로 표기한다. 다른 세션이 해당 자원에 조회 및 수정하는 것을 막고 트랜잭션이 완료할 때까지 유지된다. 즉 다른 트랜잭션은 Lock 대상에 대해 접근이 불가하다.

3. 업데이트 락(Update Lock)

   업데이트 락은 테이블을 수정하기 위해 베타 락을 걸기 전에 데드 락을 방지하고 위해서 사용한다. 일반적으론 UPDATE 쿼리의 WHERE 절에서 실행돈다.

4. 내재 락(Intent Lock)

   사용자가 요청한 범위에 대하여 락을 걸 수 있는 지 여부를 파악하기 위해 사용되며 공유락과 베타락 앞에 I를 붙여서 표기한다.
